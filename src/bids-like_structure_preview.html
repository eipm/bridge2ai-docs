<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge2AI Dataset Structure Preview</title>
    <style>
        /* Style for the file structure list */
        .file-structure {
            list-style-type: none;
            padding-left: 20px;
        }

        /* Style for individual list items */
        .file-structure li {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Style for folder names */
        .folder {
            font-weight: bold;
            cursor: pointer;
        }

        /* Style for file names */
        .file {
            font-style: italic;
        }

        /* Styles for description and file content displays, initially hidden */
        .description, .file-content {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            display: none;
        }

        /* Button style for explanations */
        .explanation-button {
            margin-left: 10px;
            padding: 2px 5px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Pre-formatted text for file contents */
        .file-content pre {
            white-space: pre-wrap; /* Keeps newlines and indents */
            word-wrap: break-word; /* Prevents overflow of long words */
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto; /* Allows horizontal scroll for long lines */
        }

        /* Center content and make file-content scrollable */
        .file-content {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            display: none;
            text-align: left;
            max-height: 80vh; /* Limit height to 80% of the viewport */
            overflow-y: auto; /* Enable vertical scrolling */
        }

        /* Scrollable container for canvas */
        .pdf-viewer {
            display: flex;
            flex-direction: column; /* Arrange canvases vertically */
            align-items: center;    /* Center canvases horizontally */
        }

        /* Center canvas */
        .pdf-viewer canvas {
            margin: 10px 0; /* Add some space between pages */
        }

        .file-structure-container {
            max-height: 400px; /* Adjust the height as needed */
            overflow-y: auto; /* Enable vertical scrolling */
            border: 1px solid #ddd; /* Optional: add a border */
            padding: 10px;
            margin-bottom: 20px; /* Space below the scrollable box */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    </script>
</head>
<body>
    <div class="file-structure-container">
        <ul id="file-structure" class="file-structure"></ul>
    </div>

    <!-- Containers for explanations and file content display -->
    <div id="description" class="description"></div>
    <div id="file-content" class="file-content"></div>

    <script>
        // Constant for the commit hash used in API requests
        const commitHash = '8a8854c0892f5aed4fd62ecf8c2ab492e2ef7fba';
        const repo = 'ibevers/bridge2ai-docs';
        const path = 'src/b2ai-data-bids-like-template';

        // Function to fetch repository contents from GitHub
        async function fetchGitHubRepoContents(repo, path = '', ref = commitHash) {
            const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${ref}`;
            console.log(`Fetching: ${url}`); // Log URL for debugging
            const response = await fetch(url);
            if (!response.ok) {
                console.error('Failed to fetch repository contents:', response.statusText);
                document.getElementById('file-structure').textContent = `Error: ${response.statusText}`;
                return [];
            }
            try {
                const files = await response.json();
                console.log('Fetched files:', files); // Log fetched files
                return files;
            } catch (error) {
                console.error('Failed to parse JSON:', error);
                document.getElementById('file-structure').textContent = `Failed to parse JSON: ${error}`;
                return [];
            }
        }

        // Function to fetch content of individual files
        async function fetchFileContent(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch file content: ${response.statusText}`);
                }
                const content = await response.text();
                return content;
            } catch (error) {
                console.error('Error fetching file content:', error);
                return `Error fetching file content: ${error}`;
            }
        }
        const explanations = {
            "CHANGES.md": "CHANGES.md: This file documents the changes, updates, and revisions made to the project over time.",
            "README.md": "README.md: This file provides an overview of the project, including its purpose, structure, and usage instructions.",
            "dataset_description.json": "dataset_description.json: This JSON file describes the dataset, including information such as the dataset's purpose, structure, and relevant metadata.",
            "participants.json": "participants.json: This JSON file contains metadata about the participants involved in the study, including demographic information and other relevant details.",
            "participants.tsv": "participants.tsv: This TSV file lists the participants involved in the study, along with their corresponding IDs and other relevant information.",
            "phenotype": "phenotype: The phenotype directory stores participant-specific data that is not directly related to specific audio tasks but is relevant for understanding participants' characteristics.",
            "<measurement_tool_name>.json": "<measurement_tool_name>.json: This JSON file provides metadata or additional information about the phenotype data collected using a specific measurement tool.",
            "<measurement_tool_name>.tsv": "<measurement_tool_name>.tsv: This TSV file contains phenotype data collected using a specific measurement tool.",
            "sub-<participant_id>": "sub-<participant_id>: This directory contains data specific to an individual participant, organized by session.",
            "ses-<another_session_id>": "ses-<another_session_id>: This directory contains session-specific data for another participant, including behavioral and voice data.",
            "ses-<session_id>": "ses-<session_id>: This directory contains session-specific data for another participant, including behavioral and voice data.",
            "beh": "beh: This directory contains behavioral data collected during the session.",
            "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_metadata.json": "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_metadata.json: This JSON file contains metadata about the behavioral task, including information such as task conditions and settings.",
            "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_response.json": "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_response.json: This JSON file contains the participant's responses for a specific task and run.",
            "voice": "voice: This directory contains voice data collected during the session.",
            "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_audio.wav": "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_audio.wav: This is the raw audio recording file for a specific task and run.",
            "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_features.pt": "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_features.pt: This file contains extracted features from the audio recording, stored in a format suitable for further analysis.",
            "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_transcript.txt": "sub-<participant_id>_ses-<session_id>_task-<task_name>_run-<index>_transcript.txt: This text file contains the transcript of the audio recording for a specific task and run.",
            "sessions.tsv": "sessions.tsv: This TSV file lists all sessions for the participant, including session IDs and other relevant details.",
            "B2AI-Voice-LICENSE-v1.0_Sep12 clean.pdf": "B2AI-Voice-LICENSE-v1.0_Sep12 clean.pdf: License file describing usage terms for the dataset.",
    
            // Phenotype-related files
            "adhd.json": "adhd.json: TSV column names with explanations for ADHD-related data.",
            "adhd.tsv": "adhd.tsv: ADHD-related participant data.",
            "airwaystenosis.json": "airwaystenosis.json: TSV column names with explanations for airway stenosis-related data.",
            "airwaystenosis.tsv": "airwaystenosis.tsv: Airway stenosis-related participant data.",
            "als.json": "als.json: TSV column names with explanations for ALS-related data.",
            "als.tsv": "als.tsv: ALS-related participant data.",
            "alzheimers.json": "alzheimers.json: TSV column names with explanations for Alzheimer's disease-related data.",
            "alzheimers.tsv": "alzheimers.tsv: Alzheimer's disease-related participant data.",
            "benignLesion.json": "benignLesion.json: TSV column names with explanations for benign lesion-related data.",
            "benignLesion.tsv": "benignLesion.tsv: Benign lesion-related participant data.",
            "bipolar.json": "bipolar.json: TSV column names with explanations for bipolar disorder-related data.",
            "bipolar.tsv": "bipolar.tsv: Bipolar disorder-related participant data.",
            "confounders.json": "confounders.json: TSV column names with explanations for confounding factors in the study.",
            "confounders.tsv": "confounders.tsv: Data for confounding factors.",
            "customAffectScale.json": "customAffectScale.json: TSV column names with explanations for custom affect scale.",
            "customAffectScale.tsv": "customAffectScale.tsv: Data for custom affect scale.",
            "demographics.json": "demographics.json: TSV column names with explanations for participant demographics.",
            "demographics.tsv": "demographics.tsv: Participant demographics data.",
            "depression.json": "depression.json: TSV column names with explanations for depression-related data.",
            "depression.tsv": "depression.tsv: Depression-related participant data.",
            "dsm5.json": "dsm5.json: TSV column names with explanations for DSM-5 criteria.",
            "dsm5.tsv": "dsm5.tsv: DSM-5 criteria participant data.",
            "dyspnea.json": "dyspnea.json: TSV column names with explanations for dyspnea-related data.",
            "dyspnea.tsv": "dyspnea.tsv: Dyspnea-related participant data.",
            "eligibility.json": "eligibility.json: TSV column names with explanations for study eligibility criteria.",
            "eligibility.tsv": "eligibility.tsv: Data on study eligibility.",
            "enrollment.json": "enrollment.json: TSV column names with explanations for participant enrollment.",
            "enrollment.tsv": "enrollment.tsv: Participant enrollment data.",
            "gad7.json": "gad7.json: TSV column names with explanations for GAD-7 anxiety scale.",
            "gad7.tsv": "gad7.tsv: GAD-7 anxiety scale participant data.",
            "laryngealCancer.json": "laryngealCancer.json: TSV column names with explanations for laryngeal cancer-related data.",
            "laryngealCancer.tsv": "laryngealCancer.tsv: Laryngeal cancer-related participant data.",
            "laryngealDystonia.json": "laryngealDystonia.json: TSV column names with explanations for laryngeal dystonia-related data.",
            "laryngealDystonia.tsv": "laryngealDystonia.tsv: Laryngeal dystonia-related participant data.",
            "leicester.json": "leicester.json: TSV column names with explanations for Leicester cough questionnaire.",
            "leicester.tsv": "leicester.tsv: Leicester cough questionnaire data.",
            "panas.json": "panas.json: TSV column names with explanations for PANAS (positive and negative affect scale).",
            "panas.tsv": "panas.tsv: PANAS participant data.",
            "parkinsons.json": "parkinsons.json: TSV column names with explanations for Parkinson's disease-related data.",
            "parkinsons.tsv": "parkinsons.tsv: Parkinson's disease-related participant data.",
            "participant.json": "participant.json: TSV column names with explanations for individual participants.",
            "participant.tsv": "participant.tsv: Data for individual participants.",
            "phq9.json": "phq9.json: TSV column names with explanations for PHQ-9 depression scale.",
            "phq9.tsv": "phq9.tsv: PHQ-9 depression scale participant data.",
            "precancerousLesions.json": "precancerousLesions.json: TSV column names with explanations for precancerous lesions data.",
            "precancerousLesions.tsv": "precancerousLesions.tsv: Precancerous lesions participant data.",
            "ptsd.json": "ptsd.json: TSV column names with explanations for PTSD-related data.",
            "ptsd.tsv": "ptsd.tsv: PTSD-related participant data.",
            "random.json": "random.json: TSV column names with explanations for randomization data.",
            "random.tsv": "random.tsv: Randomization data.",
            "stroop.json": "stroop.json: TSV column names with explanations for Stroop test data.",
            "stroop.tsv": "stroop.tsv: Stroop test participant data.",
            "vhi10.json": "vhi10.json: TSV column names with explanations for Voice Handicap Index (VHI-10).",
            "vhi10.tsv": "vhi10.tsv: VHI-10 participant data.",
            "vocab.json": "vocab.json: TSV column names with explanations for vocabulary assessment.",
            "vocab.tsv": "vocab.tsv: Vocabulary assessment data.",
            "vocalFoldParalysis.json": "vocalFoldParalysis.json: TSV column names with explanations for vocal fold paralysis data.",
            "vocalFoldParalysis.tsv": "vocalFoldParalysis.tsv: Vocal fold paralysis participant data.",
            "voicePerception.json": "voicePerception.json: TSV column names with explanations for voice perception data.",
            "voicePerception.tsv": "voicePerception.tsv: Voice perception participant data.",
            "voiceSeverity.json": "voiceSeverity.json: TSV column names with explanations for voice severity data.",
            "voiceSeverity.tsv": "voiceSeverity.tsv: Voice severity participant data.",
            "winograd.json": "winograd.json: TSV column names with explanations for Winograd schema data.",
            "winograd.tsv": "winograd.tsv: Winograd schema participant data."
        };


       // Function to toggle explanations and file content
       async function toggleExplanation(file) {
            const description = document.getElementById('description');
            const fileContentBox = document.getElementById('file-content');

            // Display explanation text based on file name
            const customExplanation = explanations[file.name] || `${file.name}: No specific explanation available.`;
            description.textContent = customExplanation;
            description.style.display = 'block';

            // Clear previous content
            fileContentBox.innerHTML = '';

            if (file.type === 'file') {
                if (file.name.endsWith('.pdf')) {
                    // Render PDF in a scrollable, centered container
                    const pdfViewer = document.createElement('div');
                    pdfViewer.className = 'pdf-viewer';
                    fileContentBox.appendChild(pdfViewer);
                    fileContentBox.style.display = 'block';

                    try {
                        // Fetch PDF data
                        const pdfData = await fetch(file.download_url).then(res => res.arrayBuffer());
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

                        const numPages = pdf.numPages;

                        // Function to render a single page
                        const renderPage = async (pageNum) => {
                            const page = await pdf.getPage(pageNum);
                            const viewport = page.getViewport({ scale: 1.5 });

                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;

                            // Render the page onto the canvas
                            await page.render({ canvasContext: context, viewport: viewport }).promise;

                            // Append the canvas to the viewer
                            pdfViewer.appendChild(canvas);
                        };

                        // Render all pages sequentially
                        for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                            await renderPage(pageNum);
                        }
                    } catch (error) {
                        console.error('Error rendering PDF:', error);
                        fileContentBox.innerHTML = `<p>Error rendering PDF: ${error.message}</p>`;
                    }
                } else {
                    // Fetch and display text-based file content
                    const content = await fetchFileContent(file.download_url);
                    fileContentBox.innerHTML = `<pre>${content}</pre>`;
                    fileContentBox.style.display = 'block';
                }
            } else {
                fileContentBox.style.display = 'none';
            }
        }



        // Fetch and render file structure on DOM load
        document.addEventListener('DOMContentLoaded', async () => {
            const repo = 'ibevers/bridge2ai-docs'; // GitHub repository
            const path = 'src/b2ai-data-bids-like-template'; // Directory path in repository
            const files = await fetchGitHubRepoContents(repo, path, commitHash);
            if (files.length === 0) {
                document.getElementById('file-structure').textContent = 'No files found or failed to load directory contents.';
            } else {
                const fileStructureContainer = document.getElementById('file-structure');
                renderFiles(files, fileStructureContainer);
            }
        });

        // Renders files and directories into HTML structure
        function renderFiles(files, container) {
            container.innerHTML = ''; // Clear previous content
            files.forEach(file => {
                const li = document.createElement('li');
                li.className = file.type === 'dir' ? 'folder' : 'file';

                const textSpan = document.createElement('span');
                textSpan.textContent = file.name;
                textSpan.className = li.className;

                const explanationButton = document.createElement('button');
                explanationButton.textContent = 'Explanation';
                explanationButton.className = 'explanation-button';
                explanationButton.addEventListener('click', () => toggleExplanation(file));

                li.appendChild(textSpan);
                li.appendChild(explanationButton);

                if (file.type === 'dir') {
                    textSpan.addEventListener('click', async () => {
                        const subFiles = await fetchGitHubRepoContents(repo, file.path, commitHash);
                        const ul = document.createElement('ul');
                        ul.className = 'file-structure';
                        renderFiles(subFiles, ul);
                        if (li.nextElementSibling && li.nextElementSibling.tagName === 'UL') {
                            li.parentNode.removeChild(li.nextElementSibling); // Remove if already open
                        } else {
                            li.insertAdjacentElement('afterend', ul); // Insert sub-directory
                        }
                    });
                }

                container.appendChild(li);
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const files = await fetchGitHubRepoContents(repo, path, commitHash);
            if (files.length === 0) {
                document.getElementById('file-structure').textContent = 'No files found or failed to load directory contents.';
            } else {
                const fileStructureContainer = document.getElementById('file-structure');
                renderFiles(files, fileStructureContainer);
            }
        });
    </script>
</body>
</html>
